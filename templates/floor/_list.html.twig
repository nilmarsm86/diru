{% if building.hasErrors(not reply) %}
    {% set card_icon = ux_icon('material-symbols:dangerous', {
        'class':'bi text-danger',
        'data-bs-toggle':"tooltip",
        'data-bs-title':"Revisar datos de las plantas.",
        'data-bs-custom-class':"danger-tooltip"
    }) %}
{% else %}
    {% set card_icon = ux_icon('ep:success-filled', {
        'class':'bi text-success',
    }) %}
{% endif %}

{% component 'Card:Card' with {
    cssClass: 'mb-4',
    extra: '',
    headerCssClass: 'd-flex justify-content-between align-items-center',
    title: reply ? 'Listado de plantas replicadas' : 'Listado de plantas',
    icon: card_icon
} %}
    {% block header %}
        {% from 'macros/buttons.html.twig' import tableActionButton2,tableActionButton3 %}

        <div>
            {% if building.hasReply() %}
                {% if reply %}
                    {{ tableActionButton3("", '', 'Sistema constructivo', 'Clasificar sistema constructivo') }}
                {% endif %}
                {{ tableActionButton3(path('app_floor_index', {'building': building.id, 'reply':(not reply)}), 'dinkie-icons:house-buildings-small', (reply) ? 'Plantas existentes' : 'Plantas a modificar', (reply) ? 'Plantas existentes' : 'Plantas a modificar') }}
            {% endif %}

            {% if building.canReply() and building.hasErrors(not reply) == false %}
                {{ tableActionButton3(path('app_building_reply', {'id':building.id}), 'gis:copy-poly', 'Salvar', 'Crear inmueble a modificar') }}
            {% endif %}

            <div class="dropdown d-inline-block">
                <button type="button"
                        class="btn text-decoration-none btn-sm dropdown-toggle show dropdown-sm btn-info"
                        data-bs-toggle="dropdown"
                        aria-expanded="false" title="Obras del proyecto"
                >
                    Reportes
                </button>
                <ul class="dropdown-menu" data-bs-theme="light">
                    <li>
                        <a class="dropdown-item"
                           href="" title="">
                            Reporte por locales
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item"
                           href="" title="">
                            Reporte por metros cuadrados
                        </a>
                    </li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li>
                        <a class="dropdown-item"
                           href="" title="">
                            Reporte descripcion por locales (PDF)
                        </a>
                    </li>
                </ul>
            </div>

            {#            {% if (building.isNew() or building.hasReplyFloors()) or reply %} #}
            {% if building.isNew() or reply %}
                {% set path = path('app_floor_new', {'building':building.id, 'reply': reply}) %}
                {{ tableActionButton3(path, 'bi:plus-lg', 'Nueva', 'Nueva planta', stimulusAction('twig/card/card', 'newElement:prevent', null, {url:path})) }}
            {% endif %}
            {{ tableActionButton3(path('app_building_edit', {id:building.id}), 'streamline-pixel:construction-building-real-eastate', 'Ir a la obra', 'Ir a la obra') }}
        </div>
    {% endblock %}

    {% block body %}
        {% component 'Table:Table' with {
            paginator: paginator,
        } %}

            {% block message %}
                {{ include('structure/_table_message.html.twig', {
                    isNew: building.isNew(),
                    maxArea: building.getMaxArea(),
                    isFullyOccupied: building.isFullyOccupied(),
                    hasFreeArea: building.hasFreeArea(),
                    freeArea: building.getFreeArea(),
                    hasUnassignedArea: building.hasUnassignedArea(),
                    unassignedArea: building.getUnassignedArea(),
                    landArea: building.getLandArea(),
                }) }}

{#                {% if building.hasFreeArea() %}#}
{#                    <br>#}
{#                    <a href="{{ path('app_land_unassigned-free', {'id': building.land.id, 'building': building.id, 'reply': reply }) }}">#}
{#                        Convertir en área sin asignar#}
{#                    </a>#}
{#                {% endif %}#}

{#                {% if building.hasUnassignedArea() %}#}
{#                    <br>#}
{#                    <a href="{{ path('app_land_unassigned-free', {'id': building.land.id, 'building': building.id, 'reply': reply }) }}">#}
{#                        Convertir en área libre#}
{#                    </a>#}
{#                {% endif %}#}
            {% endblock %}

            {% block tableHead %}
                <tr>
                    <th>#</th>
                    <th>Nombre</th>
                    <th></th>
                    <th>Á. Util (m<sup>2</sup>)</th>
                    <th title="Área de Muro y Columna">Á.M.C (m<sup>2</sup>)</th>
                    <th>Á. Vacío (m<sup>2</sup>)</th>
                    <th title="Área Total de Planta">Á.T.P (m<sup>2</sup>)</th>
                    <th>Altura (m)</th>
                    <th>Volumen (m<sup>3</sup>)</th>
                    <th>Sin asignar (m<sup>2</sup>)</th>
                    <th>Libre (m<sup>2</sup>)</th>
                    {% if reply or building.isNew() %}
                        <th>Importe (CUP)</th>
                    {% endif %}
                    <th></th>
                </tr>
            {% endblock %}

            {% block tableBody %}
                {% from 'macros/buttons.html.twig' import tableActionButton, deleteFormButton, deleteFormButton2, tableActionButton2, tableActionButton3 %}

                {% for floor in paginator.getData() %}
                    <tr {{ stimulusController('delete-form-container') }}
                        class="
                        {% if floor.inNewBuilding() or floor.isNewInReply() %}table-success {% endif %}
                        {% if floor.hasChangesFromOriginal() %} table-info {% endif %}
                        {% if floor.hasRemoveConstructiveAction() %} table-danger {% endif %}
                        "
                    >
                        <td>
                            {{ floor.position }}
                        </td>
                        <td>
                            {% if floor.hasChangesFromOriginal() %}
                                <em>{{ floor.name }}</em>{% else %}{{ floor.name }}{% endif %}
                        </td>
                        <td>
                            {% if reply %}
                                <span class="badge rounded-pill bg-success"
                                      title="Subsistemas replicados de la planta" data-bs-toggle="tooltip"
                                      style="cursor: pointer">
                                    {{ floor.getSubSystemAmount(false) }}
                                    <span class="visually-hidden">Subsistemas</span>
                                </span>
                            {% else %}
                                <span
                                    class="badge rounded-pill {% if floor.hasOriginalSubSystems() %}bg-success{% else %}bg-danger{% endif %}"
                                    title="Subsistemas de la planta" data-bs-toggle="tooltip"
                                      {% if floor.hasOriginalSubSystems() == false %}
                                          data-bs-title="No tiene definido subsistema." data-bs-custom-class="danger-tooltip"
                                      {% endif %}
                                      style="cursor: pointer">
                                    {{ floor.getSubSystemAmount() }}
                                    <span class="visually-hidden">Subsistemas</span>
                                </span>
                            {% endif %}
                        </td>

                        <td>
                            {% if floor.isFullyOccupied() %}
                                {{ floor.getUsefulArea()|number_format(2) }}
                            {% else %}
                                <span class="text-warning" data-bs-toggle="tooltip"
                                      data-bs-title="Queda espacio sin aprovechar."
                                      data-bs-custom-class="warning-tooltip" style="cursor: pointer">
                                    {{ floor.getUsefulArea()|number_format(2) }}
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if floor.notWallArea() %}
                                <span class="text-danger" data-bs-toggle="tooltip"
                                      data-bs-title="Debe tener área de muro." data-bs-custom-class="danger-tooltip"
                                      style="cursor: pointer">
                                    {{ floor.getWallArea()|number_format(2) }}
                                </span>
                            {% else %}
                                {{ floor.getWallArea()|number_format(2) }}
                            {% endif %}
                        </td>
                        <td>{{ floor.getEmptyArea()|number_format(2) }}</td>
                        <td>{{ floor.getTotalArea()|number_format(2) }}</td>
                        <td>{{ floor.getMaxHeight()|number_format(2) }}</td>
                        <td>{{ floor.getVolume()|number_format(2) }}</td>
                        <td>
                            {% if floor.isFullyOccupied() %}
                                {{ floor.getUnassignedArea()|number_format(2) }}
                            {% else %}
                                <span class="text-warning" data-bs-toggle="tooltip"
                                      data-bs-title="Queda espacio sin aprovechar."
                                      data-bs-custom-class="warning-tooltip" style="cursor: pointer">
                                    {{ floor.getUnassignedArea()|number_format(2) }}
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if floor.isFullyOccupied() %}
                                {{ floor.getFreeArea()|number_format(2) }}
                            {% else %}
                                <span class="text-warning" data-bs-toggle="tooltip"
                                      data-bs-title="Queda espacio libre."
                                      data-bs-custom-class="warning-tooltip" style="cursor: pointer">
                                    {{ floor.getFreeArea()|number_format(2) }}
                                </span>
                            {% endif %}
                        </td>
                        {% if reply or building.isNew() %}
                            <td>{{ money(floor.getPrice()) }}</td>
                        {% endif %}
                        <td class="text-end">
                            {#                            {{ tableActionButton3(path('app_floor_show', {'id': floor.id, 'building':building.id}), 'bi:eye', '', 'Detalle de la planta', stimulusAction('twig/table/table', 'selectElement:prevent', null, {url:path('app_floor_show', {'id': floor.id, 'building':building.id})})) }} #}
                            {% set cssClass = 'btn-link' %}
                            {% if floor.hasBackgroundColorOfChange() %}
                                {% set cssClass = cssClass ~ ' text-dark' %}
                            {% endif %}

                            <div class="dropdown d-inline-block" data-bs-toggle="tooltip" title="Reportes">
                                <button type="button"
                                        class="btn text-decoration-none btn-sm dropdown-toggle show dropdown-sm {{ cssClass }}"
                                        data-bs-toggle="dropdown"
                                        aria-expanded="false" title="Reportes"
                                >
                                    R
                                </button>
                                <ul class="dropdown-menu" data-bs-theme="light">
                                    <li>
                                        <a class="dropdown-item"
                                           href="{{ path('app_floor_report_local', {'id': floor.id}) }}"
                                           title="">
                                            Reporte de estado técnico
                                        </a>
                                    </li>
                                    {#                                    <li> #}
                                    {#                                        <a class="dropdown-item" #}
                                    {#                                           href="" title=""> #}
                                    {#                                            Reporte de estado técnico por metros cuadrados #}
                                    {#                                        </a> #}
                                    {#                                    </li> #}
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li>
                                        <a class="dropdown-item"
                                           href="" title="">
                                            Reporte de descripción por locales (PDF)
                                        </a>
                                    </li>
                                </ul>
                            </div>

                            {{ tableActionButton3(path('app_sub_system_index', {'floor': floor.id, 'reply':reply}), 'ix:building-block' , '', (reply) ? ((floor.isNewInReply()) ? 'Subsistemas nuevos' : 'Subsistemas replicados') : 'Subsistemas', '', cssClass, floor.hasErrors()) }}
                            {#                            {{ tableActionButton3(path('app_local_index', {'floor': floor.id}), 'lucide-lab:floor-plan', '', 'Locales', '', 'btn-info') }} #}
                            {% if floor.hasReply() == false %}
                                {{ tableActionButton3(path('app_floor_edit', {'id': floor.id, 'building':building.id}), 'fa:edit', '', 'Editar planta', stimulusAction('twig/table/table', 'selectElement:prevent', null, {url:path('app_floor_edit', {'id': floor.id, 'building':building.id})}), cssClass) }}
                            {% endif %}

                            {% if floor.inNewBuilding() or floor.hasReply() == false %}
                                {{ component('DeleteForm', {
                                    path: path('app_floor_delete', {'id': floor.id}),
                                    confirm: 'Está seguro que desea eliminar la planta?',
                                    token: 'delete' ~ floor.id,
                                    title: 'Eliminar planta',
                                    icon: 'bi:trash',
                                    active: floor.isGroundFloor() == false,
                                    cssClass: 'btn-link text-danger'
                                }) }}
                            {% endif %}
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="9">No se encontraron plantas.</td>
                    </tr>
                {% endfor %}
            {% endblock %}

            {% block tableFooter %}
                <tr>
                    <th colspan="3">Resumen del inmueble:</th>
                    <th>{{ building.getUsefulArea(not reply)|number_format(2) }}</th>
                    <th>{{ building.getWallArea(not reply)|number_format(2) }}</th>
                    <th>{{ building.getEmptyArea(not reply)|number_format(2) }}</th>
                    <th>{{ building.getTotalArea(not reply)|number_format(2) }}</th>
                    <th>{{ building.getMaxHeight(not reply)|number_format(2) }}</th>
                    <th>{{ building.getVolume(not reply)|number_format(2) }}</th>
                    <th>{{ building.getUnassignedArea(not reply)|number_format(2) }}</th>
                    <th>{{ building.getFreeArea(not reply)|number_format(2) }}</th>
                    {% if reply or building.isNew() %}
                        <th>{{ money(building.getPrice()) }}</th>
                    {% endif %}
                    <th class="text-end">CUS: {{ building.getCus(not reply)|number_format(2) }}</th>
                </tr>
            {% endblock %}

        {% endcomponent %}

    {% endblock %}

{% endcomponent %}

 {% component 'Card:Card' with {
     cssClass: 'mb-4',
     extra: '',
     headerCssClass: 'd-flex justify-content-between align-items-center',
     title: 'Resumen del inmueble',
 } %}
     {% block body %}
         <table class="table table-hover">
             <tbody>
             <tr>
                 <th>Plantas:</th>
                 <td>{{ building.getFloorsAmount() }}</td>

                 <th>Subsistemas:</th>
                 <td>{{ building.getSubsystemsAmount() }}</td>
             </tr>

             <tr>
                 <th>Locales:</th>
                 <td>{{ building.getLocalsAmount(reply) }}</td>

                 <th></th>
                 <td></td>
             </tr>

             <tr>
                 <th>CUS:</th>
                 <td>{{ building.getCus(not reply)|number_format(2) }}</td>

                 <th>COS:</th>
                 <td>{{ building.getCos(not reply)|number_format(2) }} %</td>
             </tr>
             </tbody>
         </table>
     {% endblock %}

 {% endcomponent %}
